---
title: "Market Making"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(learnr)
library(gradethis)
gradethis::gradethis_setup()
library(RTL)
library(tidyverse)
library(lubridate)
library(rhandsontable)
knitr::opts_chunk$set(echo = FALSE)
```

## About the Game

This interactive tutorial aims at two objectives:

1. Testing your learning pertaining to pricing Calendar Month Average ("CMA") swaps.
2. Providing a simplified market making learning experience where you are a trader providing market making services on WTI crude to other internal counterparts and external risk management services to oil producers interested in hedging their production. Examples:

  + The gasoline desk wants to take a position on a crack spread and needs to transact in WTI futures.
  + Producer `NetZero2050 Inc` wants to hedge the next calendar year production.

The desired competenties in the job are:

1. Know your exposure at all times. 
2. Be ready at all times to make a market.
3. Hedge your risk as quickly as you can accounting for liquidity. 

A market making desk does not carry exposure to flat price at any time. 

+ Your delta limit to flat price exposure is zero.
+ You are allowed to carry time spread exposure as part of the hedging process arising from customer activity only.

## Review - Swap Pricing

### Expiry Dates

```{r}
x = expiry_table %>% dplyr::filter(cmdty == "cmewti", Last.Trade > Sys.Date()) %>% dplyr::slice(1:20) %>% dplyr::sample_n(1) %>% dplyr::select(ticker, Last.Trade)
cc <- stringr::str_replace_all(x$ticker,"[^[:alnum:]]","")
dd <-  as.character(x$Last.Trade)
sw <-  expiry_table %>% dplyr::filter(cmdty == "cmewti", Last.Trade >= dd) %>% slice(1:3)
```

What is expiry date for `r cc`? Type your answer as `"YYYY-MM-DD"` including the quotation marks and click `Submit Answer`.

```{r expiry, exercise = TRUE, exercise.timelimit = 120}

```
 
```{r expiry-check}
grade_result(
  pass_if(~identical(.result, dd))
)
```

### Futures And CMA Swaps

```{r futmonths}
learnr::question(paste("Select the futures contract(s) applicable to pricing a WTI CMA for",
                       lubridate::month(sw[1,"Month"], label = T, abbr = F) %>% as.character(),
                       sw[1,"Year"],":"),
                 learnr::answer(paste(lubridate::month(sw[1,"Month"], label = T, abbr = F) %>% as.character(),sw[1,"Year"])),
                 learnr::answer(paste(lubridate::month(sw[2,"Month"], label = T, abbr = F) %>% as.character(),sw[2,"Year"]), correct = TRUE),
                 learnr::answer(paste(lubridate::month(sw[3,"Month"], label = T, abbr = F) %>% as.character(),sw[3,"Year"]), correct = TRUE))
```

## Game 1

```{r}
# Base random date prices - wide
wti <- dfwide %>% dplyr::select(date,tidyselect::contains("CL"))
dd <- wti %>% 
  dplyr::filter(lubridate::day(date) <= 15) %>% 
  dplyr::slice_sample(n = 1) %>% dplyr::select(date) %>% .[[1]]
wti <- wti %>% dplyr::filter(date >= dd) %>% dplyr::slice(1:6) %>% dplyr::select(colnames(wti)[1:15])
tickers <- expiry_table %>% dplyr::filter(cmdty == "cmewti", Last.Trade > dd) %>% 
  dplyr::slice(1:15) %>% dplyr::transmute(ticker = stringr::str_replace_all(ticker,"[^[:alnum:]]","")) %>% .[[1]]
colnames(wti) <-  paste(c("date", tickers))
# Returns
ret_long <- wti %>% 
  tidyr::pivot_longer(-date,names_to = "series",values_to = "value") %>% 
  dplyr::group_by(series) %>% 
  dplyr::mutate(ret = value - dplyr::lag(value)) %>% stats::na.omit()
```

```{r, echo = F}
rHandsontableOutput("hot")
```


```{r, context = "server"}
day0 = wti %>% dplyr::slice(1) %>% dplyr::select(-date)
day0 <- dplyr::as_tibble(cbind(contract = names(day0),t(day0))) %>%  
  dplyr::rename(Settle = V2) %>% 
  dplyr::mutate(ExpoHedge = 0,
                ExpoSwap = 0)

#df1 <- shiny::reactive({day0})
output$hot <- renderRHandsontable({
  rhandsontable::rhandsontable(day0,rowHeaders = NULL)
    })


 #%>% hot_to_r()
```



### Exercise with Hint

*Here's an exercise where the chunk is pre-evaluated via the `exercise.eval` option (so the user can see the default output we'd like them to customize). We also add a "hint" to the correct solution via the chunk immediate below labeled `print-limit-hint`.*

Modify the following code to limit the number of rows printed to 5:

```{r print-limit, exercise=TRUE, exercise.eval=TRUE}
mtcars
```

```{r print-limit-hint}
head(mtcars)
```

### Quiz

*You can include any number of single or multiple choice questions as a quiz. Use the `question` function to define a question and the `quiz` function for grouping multiple questions together.*

Some questions to verify that you understand the purposes of various base and recommended R packages:



